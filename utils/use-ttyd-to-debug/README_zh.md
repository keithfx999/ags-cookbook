# 使用 ttyd 在沙箱中进行 Web 终端调试

通过在 Agent Sandbox 沙箱中部署 [ttyd](https://github.com/tsl0922/ttyd)，获取一个可通过浏览器访问的 Web 终端，方便对沙箱环境进行实时调试和交互操作。

## 工作原理

```
本地脚本                    Agent Sandbox 沙箱
┌──────────┐               ┌───────────────────┐
│          │  上传 ttyd    │                   │
│  main.py │──────────────>│  /root/ttyd       │
│          │               │     │              │
│          │  启动服务      │     ▼              │
│          │──────────────>│  ttyd -p 8080 bash│
│          │               │     │              │
│          │  获取访问链接   │     ▼              │
│          │<──────────────│  Web 终端 :8080    │
└──────────┘               └───────────────────┘
      │
      ▼
  浏览器打开链接 → 进入沙箱 bash 终端
```

## 核心特性

- **Web 终端访问**：通过浏览器直接访问沙箱内的 bash 终端
- **实时调试**：在沙箱中执行任意命令，查看文件、进程、网络等信息
- **自动下载**：首次运行自动从 GitHub 下载 ttyd 二进制文件，无需手动准备
- **智能检测**：自动检测沙箱中 ttyd 文件、进程和端口状态，避免重复操作
- **安全访问**：通过 access_token 进行身份验证

## 适用场景

- 调试沙箱内的程序运行问题
- 检查沙箱的文件系统和环境配置
- 实时监控沙箱内的进程和资源使用
- 在沙箱中交互式地执行命令和测试

## 快速开始

### 1. 安装依赖

```bash
uv sync
```

### 2. 配置环境变量

> ttyd 二进制文件会在首次运行时自动从 [GitHub Releases](https://github.com/tsl0922/ttyd/releases/tag/1.7.7) 下载，无需手动准备。

```bash
cp .env.example .env
```

编辑 `.env` 文件，填入实际值：

```dotenv
E2B_DOMAIN=ap-chongqing.tencentags.com
E2B_API_KEY=your_api_key_here
SANDBOX_ID=your_sandbox_id
```

### 3. 运行

```bash
uv run main.py
```

运行后会输出一个 Web 终端的访问链接，在浏览器中打开即可进入沙箱的 bash 终端。

## 输出示例

首次运行（自动下载 ttyd 并上传启动）：

```
未找到 ttyd 二进制文件: /path/to/ttyd.i686
正在从 GitHub 下载 ttyd ...
下载地址: https://github.com/tsl0922/ttyd/releases/download/1.7.7/ttyd.i686
  [████████████████████████████████████████] 100.0% (800KB/800KB)
下载完成: /path/to/ttyd.i686
连接到沙箱: xxxxx
沙箱连接成功: xxxxx
上传 ttyd 到沙箱...
ttyd 上传完成
启动 ttyd 服务 (端口: 8080)...
ttyd 服务已在后台启动

============================================================
ttyd Web 终端已就绪！
============================================================

访问链接:
https://xxxxx.ap-chongqing.tencentags.com/?access_token=xxxxx

在浏览器中打开上述链接即可进入沙箱终端进行调试。
============================================================
```

再次运行（检测到已存在，跳过上传和启动）：

```
ttyd 二进制文件已找到: /path/to/ttyd.i686
连接到沙箱: xxxxx
沙箱连接成功: xxxxx
沙箱中已存在 ttyd，跳过上传
ttyd 进程已在运行，跳过启动

============================================================
ttyd Web 终端已就绪！
============================================================

访问链接:
https://xxxxx.ap-chongqing.tencentags.com/?access_token=xxxxx

在浏览器中打开上述链接即可进入沙箱终端进行调试。
============================================================
```

## 依赖

- `e2b-code-interpreter` >= 2.0.0
- `python-dotenv` >= 1.0.0

## 注意事项

- ttyd 以 root 用户权限运行，请注意操作安全
- 沙箱关闭后 ttyd 服务会自动停止
- 访问链接包含 access_token，请勿泄露给他人
- 默认使用 8080 端口，可在 `main.py` 中修改 `TTYD_PORT` 变量
- 若 8080 端口已被其他进程占用，脚本会报错退出
- 重复运行时会自动跳过已完成的步骤（上传、启动），直接输出访问链接
